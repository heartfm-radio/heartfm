<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HEART FM</title>

<style>
body {
margin: 0;
background: #000;
color: #ff0000;
font-family: monospace;
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
}

.wrapper {
width: 95%;
max-width: 600px;
text-align: center;
}

.header {
font-size: 26px;
letter-spacing: 3px;
margin-bottom: 20px;
}

.line {
color: #880000;
margin: 10px 0;
}

.player-box {
border: 2px dashed #ff0000;
padding: 20px;
}

button {
background: #000;
color: #ff0000;
border: 2px solid #ff0000;
padding: 12px 30px;
font-family: monospace;
font-size: 16px;
cursor: pointer;
}

button:active {
background: #ff0000;
color: #000;
}

.track {
margin-top: 15px;
font-size: 14px;
min-height: 20px;
color: #ff4444;
}

.status {
margin-top: 10px;
min-height: 30px;
}

.loading-text {
font-size: 18px;
}

.loading-anim {
font-size: 12px;
letter-spacing: 2px;
}
</style>
</head>

<body>

<div class="wrapper">

<div class="header">----- HEART FM -----</div>
<div class="line">------------------------------------------</div>

<div class="player-box">
<button id="playBtn">▶ ПУСК</button>
<div class="track" id="trackName">-- ожидание сигнала --</div>

<div class="status">
<div class="loading-text" id="loadingText"></div>
<div class="loading-anim" id="loadingAnim"></div>
</div>

</div>

<div class="line">------------------------------------------</div>

</div>

<audio id="radio" playsinline preload="none"></audio>

<script>

const STREAM_URL = "https://icecast.gtrk22.ru:8443/heartfm";
const STATUS_URL = "https://icecast.gtrk22.ru:8443/status-json.xsl";

const audio = document.getElementById("radio");
const button = document.getElementById("playBtn");
const trackName = document.getElementById("trackName");
const loadingText = document.getElementById("loadingText");
const loadingAnim = document.getElementById("loadingAnim");

let isPlaying = false;
let loaderInterval = null;

const frames = [
"▁ ▂ ▃ ▄ ▅ ▆ ▇ █",
"▂ ▃ ▄ ▅ ▆ ▇ █ ▁",
"▃ ▄ ▅ ▆ ▇ █ ▁ ▂",
"▄ ▅ ▆ ▇ █ ▁ ▂ ▃"
];

let frameIndex = 0;

function startLoader() {
loadingText.textContent = "ЗАГРУЗКА";
loadingAnim.textContent = frames[frameIndex];

loaderInterval = setInterval(() => {
frameIndex = (frameIndex + 1) % frames.length;
loadingAnim.textContent = frames[frameIndex];
}, 250);
}

function stopLoader() {
clearInterval(loaderInterval);
loaderInterval = null;
loadingText.textContent = "";
loadingAnim.textContent = "";
}

button.addEventListener("click", () => {

if (!isPlaying) {

startLoader();

audio.src = STREAM_URL;
audio.load();

const playPromise = audio.play();

if (playPromise !== undefined) {
playPromise
.then(() => {
})
.catch(() => {
loadingText.textContent = "Нажмите ещё раз";
});
}

} else {

audio.pause();
button.textContent = "▶ ПУСК";
trackName.textContent = "-- остановлено --";
stopLoader();
isPlaying = false;

}

});

audio.addEventListener("playing", () => {
stopLoader();
button.textContent = "■ СТОП";
isPlaying = true;
});

audio.addEventListener("waiting", () => {
if (!loaderInterval) startLoader();
});

audio.addEventListener("error", () => {
loadingText.textContent = "Ошибка подключения";
});

// === ПОЛУЧЕНИЕ НАЗВАНИЯ ТРЕКА ===

async function fetchTrack() {
try {
const response = await fetch(STATUS_URL);
const data = await response.json();

let source = data.icestats.source;

if (Array.isArray(source)) {
source = source.find(s => s.listenurl.includes("heartfm"));
}

if (source && source.title) {
trackName.textContent = "> " + source.title;
}

} catch {
trackName.textContent = "-- нет данных --";
}
}

setInterval(fetchTrack, 10000);
fetchTrack();

</script>

</body>
</html>
